name: Generate Podcast

on:
  schedule:
    # æ¯æ—¥ 06:00 JST = å‰æ—¥ 21:00 UTC
    - cron: "0 21 * * *"
  workflow_dispatch:
    inputs:
      hours:
        description: "è¨˜äº‹å–å¾—ã®æ™‚é–“ç¯„å›²ï¼ˆhours, 0=ç„¡åˆ¶é™ï¼‰"
        required: false
        default: "24"

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install

      - name: Install dependencies
        run: uv sync

      - name: Install ffmpeg
        run: sudo apt-get update -qq && sudo apt-get install -yqq ffmpeg

      - name: Verify ffmpeg
        run: ffmpeg -version | head -1

      - name: Generate podcast
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: uv run python podcast_generator.py

      - name: Deploy to gh-pages
        run: |
          # ç”Ÿæˆç‰©ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªï¼ˆMP3 å„ªå…ˆã€ãªã‘ã‚Œã° WAVï¼‰
          if ! ls audio_files/*.mp3 1>/dev/null 2>&1 && ! ls audio_files/*.wav 1>/dev/null 2>&1; then
            echo "::warning::éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            exit 0
          fi

          # gh-pages ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã° orphan ä½œæˆï¼‰
          git fetch origin gh-pages || true
          git worktree add gh-pages-deploy origin/gh-pages 2>/dev/null || {
            git worktree add --detach gh-pages-deploy
            cd gh-pages-deploy
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
            echo "# AI Auto Podcast" > index.html
            git add index.html
            cd ..
          }

          # episodes/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          mkdir -p gh-pages-deploy/episodes
          cp audio_files/*.mp3 gh-pages-deploy/episodes/ 2>/dev/null || true
          cp audio_files/*.wav gh-pages-deploy/episodes/ 2>/dev/null || true

          # feed.xml ã‚’ã‚³ãƒ”ãƒ¼
          if [ -f audio_files/feed.xml ]; then
            cp audio_files/feed.xml gh-pages-deploy/feed.xml
          fi

          # ã‚«ãƒãƒ¼ç”»åƒã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          if [ -f cover.jpg ]; then
            cp cover.jpg gh-pages-deploy/cover.jpg
          fi

      - name: Cleanup old episodes
        run: |
          if [ -f gh-pages-deploy/feed.xml ] && [ -d gh-pages-deploy/episodes ]; then
            uv run python cleanup_episodes.py gh-pages-deploy/feed.xml gh-pages-deploy/episodes
          else
            echo "feed.xml or episodes/ not found, skipping cleanup"
          fi

      - name: Commit and push
        run: |
          cd gh-pages-deploy
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --cached --quiet && {
            echo "å¤‰æ›´ãªã—ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            exit 0
          }
          git commit -m "ğŸ™ï¸ Episode $(date +%Y%m%d) deployed"
          git push origin HEAD:gh-pages

      - name: Upload episode artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: episode-${{ github.run_number }}
          path: |
            audio_files/*.mp3
            audio_files/feed.xml
            content/*.json
          retention-days: 90
          if-no-files-found: warn
